#!/bin/bash

# Maxwell CLI Wrapper
# Convenience tool for direct searches across multiple knowledge sources
#
# Note: For intelligent orchestration, let the Maxwell Skill handle your questions.
# This CLI is best for quick lookups when you already know which source you want.
#
# Usage:
#   maxwell search "<query>"                    # Search all sources
#   maxwell search "<query>" --limit 10         # Limit results per source
#   maxwell search "<query>" --sosumi-only      # Search WWDC only
#   maxwell search "<query>" --deadbeef-only    # Search Point-Free only
#   maxwell search "<query>" --exact            # Exact-term search
#   maxwell search "<query>" --semantic         # Semantic-only search
#   maxwell docc-search "<query>"               # Search Apple DocC
#   maxwell docc-fetch "<path-or-url>"          # Fetch any DocC page
#   maxwell help                                 # Show help

set -e

# Configuration
RAG_HOME="${HOME}/.smith/rag"
SOSUMI_DB="${RAG_HOME}/sosumi.db"
DEADBEF_DB="${RAG_HOME}/deadbeef.db"
DISCOVERIES_DIR="${HOME}/.claude/resources/discoveries"
DEFAULT_LIMIT=5

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Show usage
show_help() {
    cat << EOF
${BLUE}Maxwell - Apple Developer Knowledge Search${NC}

${GREEN}USAGE:${NC}
  maxwell <command> [options]

${GREEN}COMMANDS:${NC}
  search <query>            Search WWDC transcripts and documentation
                            Examples:
                              maxwell search "RealityKit animation"
                              maxwell search "SwiftUI state management"
                              maxwell search "visionOS immersive spaces"
                              maxwell search "@Shared" --deadbeef-only

  docc-search <query>       Search Apple DocC (via sosumi docs, defaults to compact/limit 5)
                            Examples:
                              maxwell docc-search "glassEffect"
                              maxwell docc-search "ScrollTransition" --limit 5
                              maxwell docc-search "View" --symbol

  docc-fetch <path-or-url>  Fetch any DocC page (via smith-doc-inspector)
                            Examples:
                              maxwell docc-fetch "swiftui/view"
                              maxwell docc-fetch "https://developer.apple.com/documentation/swiftui/view"

  discoveries <query>       Search personal discoveries only
                            (Coming soon)

  help                      Show this help message

${GREEN}OPTIONS:${NC}
  --limit N                 Limit results to N items (default: $DEFAULT_LIMIT)
  --sosumi-only             Search WWDC transcripts only
  --deadbeef-only           Search Point-Free transcripts only
  --exact                   Exact-term FTS5 search (skip embeddings)
  --semantic                Semantic-only search (no keyword matches)
  --symbol                  DocC search convenience flag (symbol type)
  -h, --help                Show this help message

${GREEN}EXAMPLES:${NC}
  # Search for RealityKit animation content
  maxwell search "RealityKit animation playback controller" --limit 10

  # Search for SwiftUI patterns
  maxwell search "Observable macro SwiftUI" --limit 5

  # Search for visionOS
  maxwell search "visionOS immersive space integration"

  # Search Point-Free only
  maxwell search "@Shared" --deadbeef-only

  # Exact-term search (symbols, APIs, errors)
  maxwell search "AnimationPlaybackController" --exact

  # Apple DocC search
  maxwell docc-search "glassEffect"
  maxwell docc-search "View" --symbol

  # Apple DocC fetch
  maxwell docc-fetch "https://developer.apple.com/documentation/swiftui/view"

EOF
}

normalize_docc_fetch_input() {
    local raw="$1"
    raw="${raw%%\?*}"
    raw="${raw%%\#*}"
    echo "$raw"
}

is_docc_path() {
    local raw="$1"
    if [[ "$raw" == https://developer.apple.com/documentation/* ]] || \
       [[ "$raw" == http://developer.apple.com/documentation/* ]] || \
       [[ "$raw" == documentation/* ]] || \
       [[ "$raw" == doc://* ]]; then
        return 0
    fi
    return 1
}

# Validate rag databases exist
check_databases() {
    local need_sosumi="$1"
    local need_deadbeef="$2"
    local has_db=0
    local missing_required=0

    if [ "$need_sosumi" -eq 1 ]; then
        if [ ! -f "$SOSUMI_DB" ]; then
            echo -e "${RED}‚ùå Error: WWDC database not found: $SOSUMI_DB${NC}"
            missing_required=1
        else
            has_db=1
        fi
    else
        if [ ! -f "$SOSUMI_DB" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  WWDC database not found: $SOSUMI_DB${NC}"
        else
            has_db=1
        fi
    fi

    if [ "$need_deadbeef" -eq 1 ]; then
        if [ ! -f "$DEADBEF_DB" ]; then
            echo -e "${RED}‚ùå Error: deadbeef database not found: $DEADBEF_DB${NC}"
            missing_required=1
        else
            has_db=1
        fi
    else
        if [ ! -f "$DEADBEF_DB" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  deadbeef database not found: $DEADBEF_DB${NC}"
        else
            has_db=1
        fi
    fi

    if [ "$missing_required" -eq 1 ]; then
        exit 1
    fi

    if [ "$has_db" -eq 0 ]; then
        echo -e "${RED}‚ùå Error: No RAG databases found${NC}"
        echo ""
        echo "   Maxwell requires smith-rag databases."
        echo "   Make sure smith-rag is installed and databases are initialized:"
        echo "   ${YELLOW}https://github.com/anthropics/smith-tools${NC}"
        exit 1
    fi
}

# Orchestrate searches across multiple knowledge sources
orchestrate_search() {
    local query="$1"
    local limit="${2:-$DEFAULT_LIMIT}"
    local source="${3:-all}"
    local mode="${4:-hybrid}"
    local search_sosumi=1
    local search_deadbeef=1

    if [ -z "$query" ]; then
        echo -e "${RED}‚ùå Error: query required${NC}"
        echo ""
        show_help
        exit 1
    fi

    case "$source" in
        sosumi)
            search_deadbeef=0
            ;;
        deadbeef)
            search_sosumi=0
            ;;
    esac

    check_databases "$search_sosumi" "$search_deadbeef"

    echo -e "${BLUE}üîç Maxwell: Orchestrating knowledge sources...${NC}"
    echo -e "${BLUE}Query: \"$query\"${NC}"

    local sources_label=""
    if [ "$search_sosumi" -eq 1 ]; then
        sources_label="WWDC (sosumi)"
    fi
    if [ "$search_deadbeef" -eq 1 ]; then
        if [ -n "$sources_label" ]; then
            sources_label="$sources_label + deadbeef"
        else
            sources_label="deadbeef"
        fi
    fi
    local mode_label="hybrid"
    case "$mode" in
        exact) mode_label="exact" ;;
        semantic) mode_label="semantic" ;;
    esac
    echo -e "${BLUE}Searching: $sources_label (${mode_label})${NC}\n"

    # Create temporary files for results
    local temp_sosumi=$(mktemp)
    local temp_deadbeef=$(mktemp)
    local merged_results=$(mktemp)

    # Search sosumi (WWDC & Apple)
    if [ "$search_sosumi" -eq 1 ] && [ -f "$SOSUMI_DB" ]; then
        echo -e "${GREEN}üìö Searching WWDC (sosumi)...${NC}"
        if [ "$mode" = "exact" ]; then
            smith-rag search "$query" --database "$SOSUMI_DB" --limit "$limit" --exact > "$temp_sosumi" 2>&1 || true
        elif [ "$mode" = "semantic" ]; then
            smith-rag search "$query" --database "$SOSUMI_DB" --limit "$limit" --semantic > "$temp_sosumi" 2>&1 || true
        else
            smith-rag search "$query" --database "$SOSUMI_DB" --limit "$limit" > "$temp_sosumi" 2>&1 || true
        fi
    fi

    # Search deadbeef
    if [ "$search_deadbeef" -eq 1 ] && [ -f "$DEADBEF_DB" ]; then
        echo -e "${GREEN}üìö Searching deadbeef...${NC}"
        if [ "$mode" = "exact" ]; then
            smith-rag search "$query" --database "$DEADBEF_DB" --limit "$limit" --exact > "$temp_deadbeef" 2>&1 || true
        elif [ "$mode" = "semantic" ]; then
            smith-rag search "$query" --database "$DEADBEF_DB" --limit "$limit" --semantic > "$temp_deadbeef" 2>&1 || true
        else
            smith-rag search "$query" --database "$DEADBEF_DB" --limit "$limit" > "$temp_deadbeef" 2>&1 || true
        fi
    fi

    echo ""
    echo -e "${BLUE}=== RESULTS ===${NC}\n"

    # Output sosumi results
    if [ "$search_sosumi" -eq 1 ] && [ -f "$SOSUMI_DB" ] && [ -s "$temp_sosumi" ]; then
        echo -e "${GREEN}üìï From WWDC & Apple (sosumi):${NC}"
        head -30 "$temp_sosumi" | grep -v "info smith-rag" || true
        echo ""
    fi

    # Output deadbeef results
    if [ "$search_deadbeef" -eq 1 ] && [ -f "$DEADBEF_DB" ] && [ -s "$temp_deadbeef" ]; then
        echo -e "${GREEN}üìó From deadbeef:${NC}"
        head -30 "$temp_deadbeef" | grep -v "info smith-rag" || true
        echo ""
    fi

    # Cleanup
    rm -f "$temp_sosumi" "$temp_deadbeef" "$merged_results"
}

# Main CLI logic
main() {
    case "${1:-help}" in
        search)
            shift  # Remove 'search' from args
            local query=""
            local limit="$DEFAULT_LIMIT"
            local source="all"
            local source_override=0
            local mode="hybrid"
            local mode_override=0

            # Parse arguments
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --limit)
                        limit="$2"
                        shift 2
                        ;;
                    --symbol)
                        echo -e "${RED}‚ùå Error: --symbol is only for docc-search${NC}"
                        exit 1
                        ;;
                    --sosumi-only)
                        if [ "$source_override" -eq 1 ] && [ "$source" != "sosumi" ]; then
                            echo -e "${RED}‚ùå Error: choose only one source flag${NC}"
                            exit 1
                        fi
                        source="sosumi"
                        source_override=1
                        shift
                        ;;
                    --deadbeef-only)
                        if [ "$source_override" -eq 1 ] && [ "$source" != "deadbeef" ]; then
                            echo -e "${RED}‚ùå Error: choose only one source flag${NC}"
                            exit 1
                        fi
                        source="deadbeef"
                        source_override=1
                        shift
                        ;;
                    --exact)
                        if [ "$mode_override" -eq 1 ] && [ "$mode" != "exact" ]; then
                            echo -e "${RED}‚ùå Error: choose only one search mode flag${NC}"
                            exit 1
                        fi
                        mode="exact"
                        mode_override=1
                        shift
                        ;;
                    --semantic)
                        if [ "$mode_override" -eq 1 ] && [ "$mode" != "semantic" ]; then
                            echo -e "${RED}‚ùå Error: choose only one search mode flag${NC}"
                            exit 1
                        fi
                        mode="semantic"
                        mode_override=1
                        shift
                        ;;
                    -h|--help)
                        show_help
                        exit 0
                        ;;
                    *)
                        if [ -z "$query" ]; then
                            query="$1"
                        fi
                        shift
                        ;;
                esac
            done

            if is_docc_path "$query"; then
                local doc_input
                doc_input="$(normalize_docc_fetch_input "$query")"
                smith-doc-inspector docs "$doc_input"
                exit 0
            fi

            orchestrate_search "$query" "$limit" "$source" "$mode"
            ;;

        docc-search)
            shift
            local query="$1"
            if [ -z "$query" ]; then
                echo -e "${RED}‚ùå Error: query required${NC}"
                echo ""
                show_help
                exit 1
            fi
            shift
            if is_docc_path "$query"; then
                local doc_input
                doc_input="$(normalize_docc_fetch_input "$query")"
                smith-doc-inspector docs "$doc_input"
                exit 0
            fi
            local passthrough=()
            local has_limit=0
            local has_format=0
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --symbol)
                        passthrough+=("--type" "symbol")
                        shift
                        ;;
                    --limit)
                        passthrough+=("--limit" "$2")
                        has_limit=1
                        shift 2
                        ;;
                    --format)
                        passthrough+=("--format" "$2")
                        has_format=1
                        shift 2
                        ;;
                    *)
                        passthrough+=("$1")
                        shift
                        ;;
                esac
            done
            if [ "$has_limit" -eq 0 ]; then
                passthrough+=("--limit" "5")
            fi
            if [ "$has_format" -eq 0 ]; then
                passthrough+=("--format" "compact")
            fi
            sosumi docs "$query" "${passthrough[@]}"
            ;;

        docc-fetch)
            shift
            local raw_path="$1"
            if [ -z "$raw_path" ]; then
                echo -e "${RED}‚ùå Error: path or URL required${NC}"
                echo ""
                show_help
                exit 1
            fi
            shift
            local doc_input
            doc_input="$(normalize_docc_fetch_input "$raw_path")"
            local passthrough=()
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --format)
                        if [ "$2" = "markdown" ]; then
                            passthrough+=("--format" "text")
                        else
                            passthrough+=("--format" "$2")
                        fi
                        shift 2
                        ;;
                    *)
                        passthrough+=("$1")
                        shift
                        ;;
                esac
            done
            smith-doc-inspector docs "$doc_input" "${passthrough[@]}"
            ;;

        discoveries)
            echo -e "${YELLOW}‚ö†Ô∏è  Personal discoveries coming soon${NC}"
            echo ""
            echo "For now, search for knowledge in: $DISCOVERIES_DIR"
            ls -1 "$DISCOVERIES_DIR" 2>/dev/null | head -10
            exit 1
            ;;

        help|-h|--help)
            show_help
            ;;

        *)
            echo -e "${RED}‚ùå Unknown command: $1${NC}\n"
            show_help
            exit 1
            ;;
    esac
}

# Run
main "$@"
